#!/bin/bash

export LANG=en_US.UTF-8

RED="\033[31m"
GREEN="\033[32m"
YELLOW="\033[33m"
BLUE="\033[34m"
PURPLE="\033[35m"
CYAN="\033[36m"
PLAIN="\033[0m"

red() { echo -e "${RED}$1${PLAIN}"; }
green() { echo -e "${GREEN}$1${PLAIN}"; }
yellow() { echo -e "${YELLOW}$1${PLAIN}"; }
blue() { echo -e "${BLUE}$1${PLAIN}"; }
purple() { echo -e "${PURPLE}$1${PLAIN}"; }
cyan() { echo -e "${CYAN}$1${PLAIN}"; }

# é…ç½®ç›®å½•
XRAY_DIR="/usr/local/etc/xray"
CLIENT_DIR="/root/vless-clients"
LOG_DIR="/var/log/xray"
BACKUP_DIR="/root/vless-backups"

# Reality ç›®æ ‡ï¼ˆé€Ÿåº¦ä¼˜å…ˆï¼‰
REALITY_TARGETS=(
    "www.apple.com:443"
    "www.microsoft.com:443"
    "www.lovelive-anime.jp:443"
    "www.cisco.com:443"
)

[[ $EUID -ne 0 ]] && red "[!] è¯·ä½¿ç”¨ root ç”¨æˆ·è¿è¡Œæœ¬è„šæœ¬ï¼" && exit 1

# ç³»ç»Ÿæ£€æµ‹
detect_system() {
    if [[ -f /etc/os-release ]]; then
        source /etc/os-release
        SYSTEM="$ID"
        VERSION="$VERSION_ID"
    else
        red "[!] æ— æ³•æ£€æµ‹ç³»ç»Ÿç±»å‹"
        exit 1
    fi

    case $SYSTEM in
        "ubuntu"|"debian")
            PKG_MANAGER="apt"
            PKG_INSTALL="apt install -y"
            PKG_UPDATE="apt update -y"
            ;;
        "centos"|"rhel"|"fedora"|"rocky"|"almalinux")
            PKG_MANAGER="yum"
            PKG_INSTALL="yum install -y"
            PKG_UPDATE="yum update -y"
            ;;
        *)
            red "[!] ä¸æ”¯æŒçš„ç³»ç»Ÿ: $SYSTEM"
            exit 1
            ;;
    esac

    yellow "[*] æ£€æµ‹åˆ°ç³»ç»Ÿ: $SYSTEM $VERSION"
}

# ç­‰å¾…åŒ…ç®¡ç†å™¨
wait_for_package_manager() {
    yellow "[*] æ£€æŸ¥åŒ…ç®¡ç†å™¨..."
    
    local max_attempts=60
    local attempt=0
    
    while [[ $attempt -lt $max_attempts ]]; do
        if ! fuser /var/lib/dpkg/lock-frontend /var/lib/dpkg/lock /var/cache/apt/archives/lock >/dev/null 2>&1; then
            break
        fi
        
        if [[ $attempt -eq 0 ]]; then
            yellow "[*] ç­‰å¾…åŒ…ç®¡ç†å™¨..."
        fi
        
        echo -n "."
        sleep 5
        ((attempt++))
    done
    
    echo ""
    
    if [[ $attempt -ge $max_attempts ]]; then
        killall apt apt-get dpkg 2>/dev/null
        sleep 2
        rm -f /var/lib/dpkg/lock-frontend /var/lib/dpkg/lock /var/cache/apt/archives/lock
        dpkg --configure -a
    fi
}

# å®‰è£…ä¾èµ–
install_dependencies() {
    yellow "[*] å®‰è£…ä¾èµ–å’Œå®‰å…¨å·¥å…·..."
    
    wait_for_package_manager
    $PKG_UPDATE
    
    case $SYSTEM in
        "ubuntu"|"debian")
            $PKG_INSTALL curl wget unzip tar qrencode ufw jq bc \
                         net-tools dnsutils openssl socat cron \
                         fail2ban chrony
            
            systemctl enable --now chronyd 2>/dev/null
            ;;
        "centos"|"rhel"|"fedora"|"rocky"|"almalinux")
            $PKG_INSTALL curl wget unzip tar qrencode firewalld jq bc \
                         net-tools bind-utils openssl socat \
                         fail2ban chrony
            
            systemctl enable --now chronyd
            ;;
    esac
    
    # é…ç½® fail2ban
    setup_fail2ban
}

# é…ç½® fail2ban
setup_fail2ban() {
    if command -v fail2ban-client &> /dev/null; then
        yellow "[*] é…ç½® fail2ban..."
        
        systemctl enable --now fail2ban 2>/dev/null
        
        mkdir -p /etc/fail2ban/filter.d
        cat > /etc/fail2ban/filter.d/xray.conf <<'EOF'
[Definition]
failregex = .*rejected.* from <HOST>:.*
            .*invalid.* from <HOST>:.*
            .*failed.* from <HOST>:.*
ignoreregex =
EOF

        mkdir -p /etc/fail2ban/jail.d
        cat > /etc/fail2ban/jail.d/xray.conf <<EOF
[xray]
enabled = true
port = 80,443,8443
filter = xray
logpath = $LOG_DIR/error.log
maxretry = 3
bantime = 3600
findtime = 600
EOF
        
        systemctl restart fail2ban 2>/dev/null
        green "[*] fail2ban é…ç½®å®Œæˆ"
    else
        yellow "[!] fail2ban æœªå®‰è£…ï¼Œè·³è¿‡é…ç½®"
    fi
}

# è·å–æœåŠ¡å™¨ IP
get_server_ip() {
    yellow "[*] è·å–æœåŠ¡å™¨ IP..."
    
    IP_SOURCES=(
        "https://api.ipify.org"
        "https://icanhazip.com"
        "https://ipv4.icanhazip.com"
        "https://checkip.amazonaws.com"
    )
    
    for source in "${IP_SOURCES[@]}"; do
        SERVER_IP=$(curl -s --connect-timeout 5 --max-time 10 "$source" 2>/dev/null | grep -E '^[0-9.]+$')
        [[ -n "$SERVER_IP" ]] && break
    done
    
    if [[ -z "$SERVER_IP" ]]; then
        red "[!] æ— æ³•è·å–æœåŠ¡å™¨ IP"
        exit 1
    fi
    
    yellow "[*] æœåŠ¡å™¨ IP: $SERVER_IP"
}

# æ™ºèƒ½é€‰æ‹©æœ€å¿«çš„ Reality ç›®æ ‡
select_reality_target() {
    yellow "[*] æµ‹è¯• Reality ç›®æ ‡é€Ÿåº¦..."
    
    declare -A target_speeds
    
    for target in "${REALITY_TARGETS[@]}"; do
        host="${target%:*}"
        port="${target#*:}"
        
        total_time=0
        success_count=0
        
        for i in {1..3}; do
            start_time=$(date +%s%N)
            if timeout 3 bash -c "echo > /dev/tcp/$host/$port" 2>/dev/null; then
                end_time=$(date +%s%N)
                time_ms=$(( (end_time - start_time) / 1000000 ))
                total_time=$((total_time + time_ms))
                ((success_count++))
            fi
        done
        
        if [[ $success_count -gt 0 ]]; then
            avg_time=$((total_time / success_count))
            target_speeds[$target]=$avg_time
            yellow "    $host: ${avg_time}ms"
        fi
    done
    
    REALITY_TARGET=""
    min_time=999999
    
    for target in "${!target_speeds[@]}"; do
        if [[ ${target_speeds[$target]} -lt $min_time ]]; then
            min_time=${target_speeds[$target]}
            REALITY_TARGET="$target"
        fi
    done
    
    if [[ -z "$REALITY_TARGET" ]]; then
        yellow "[!] æ‰€æœ‰ç›®æ ‡éƒ½æ— æ³•è®¿é—®ï¼Œä½¿ç”¨é»˜è®¤"
        REALITY_TARGET="${REALITY_TARGETS[0]}"
    fi
    
    REALITY_DEST="${REALITY_TARGET%:*}"
    REALITY_PORT="${REALITY_TARGET#*:}"
    
    green "[*] é€‰æ‹©æœ€å¿«ç›®æ ‡: $REALITY_DEST (${min_time}ms)"
}

# å®‰è£… Xray
install_xray() {
    yellow "[*] å®‰è£… Xray-core (æœ€æ–°ç‰ˆ)..."
    
    LATEST_VERSION=$(curl -s "https://api.github.com/repos/XTLS/Xray-core/releases/latest" | jq -r '.tag_name' | sed 's/v//')
    
    if [[ -z "$LATEST_VERSION" ]]; then
        red "[!] æ— æ³•è·å–æœ€æ–°ç‰ˆæœ¬"
        exit 1
    fi
    
    yellow "[*] æœ€æ–°ç‰ˆæœ¬: $LATEST_VERSION"
    
    ARCH=$(uname -m)
    case $ARCH in
        x86_64) ARCH="64" ;;
        aarch64) ARCH="arm64-v8a" ;;
        armv7l) ARCH="arm32-v7a" ;;
        *) red "[!] ä¸æ”¯æŒçš„æ¶æ„: $ARCH"; exit 1 ;;
    esac
    
    DOWNLOAD_URL="https://github.com/XTLS/Xray-core/releases/download/v$LATEST_VERSION/Xray-linux-$ARCH.zip"
    
    cd /tmp || exit 1
    
    if ! wget -O xray.zip "$DOWNLOAD_URL" 2>/dev/null; then
        yellow "[*] ç›´è¿å¤±è´¥ï¼Œå°è¯•é•œåƒ..."
        wget -O xray.zip "https://ghproxy.com/$DOWNLOAD_URL" || {
            red "[!] ä¸‹è½½å¤±è´¥"
            exit 1
        }
    fi
    
    unzip -o xray.zip
    
    mkdir -p /usr/local/bin /usr/local/etc/xray /var/log/xray
    mv xray /usr/local/bin/
    chmod +x /usr/local/bin/xray
    
    if /usr/local/bin/xray version | grep -q "Xray"; then
        green "[*] Xray å®‰è£…æˆåŠŸ: $(/usr/local/bin/xray version | head -1)"
    else
        red "[!] Xray å®‰è£…å¤±è´¥"
        exit 1
    fi
    
    rm -f /tmp/xray.zip /tmp/xray /tmp/geoip.dat /tmp/geosite.dat
}

# ç”Ÿæˆå¯†é’¥
generate_keys() {
    yellow "[*] ç”Ÿæˆå¯†é’¥..."
    
    mkdir -p "$XRAY_DIR" "$CLIENT_DIR" "$LOG_DIR" "$BACKUP_DIR"
    
    USER_UUID=$(cat /proc/sys/kernel/random/uuid)
    
    KEY_PAIR=$(/usr/local/bin/xray x25519)
PRIVATE_KEY=$(echo "$KEY_PAIR" | grep -i "PrivateKey" | sed -E 's/.*:[[:space:]]*//')
PUBLIC_KEY=$(echo "$KEY_PAIR" | grep -i "Hash32" | sed -E 's/.*:[[:space:]]*//')

    SHORT_ID=$(openssl rand -hex 8)
    
    if ss -tlnp | grep -q ":443 "; then
        LISTEN_PORT=$(shuf -i 10000-65000 -n 1)
        while ss -tlnp | grep -q ":$LISTEN_PORT "; do
            LISTEN_PORT=$(shuf -i 10000-65000 -n 1)
        done
        yellow "[!] 443ç«¯å£è¢«å ç”¨ï¼Œä½¿ç”¨ $LISTEN_PORT"
    else
        LISTEN_PORT=443
        green "[*] ä½¿ç”¨æœ€ä¼˜ç«¯å£: 443"
    fi
    
    cat > "$XRAY_DIR/keys.txt" <<EOF
Private Key: $PRIVATE_KEY
Public Key: $PUBLIC_KEY
UUID: $USER_UUID
Short ID: $SHORT_ID
Listen Port: $LISTEN_PORT
Reality Target: $REALITY_DEST:$REALITY_PORT
Install Date: $(date)
EOF
    chmod 600 "$XRAY_DIR/keys.txt"
}

# é…ç½® Xray æœåŠ¡å™¨ï¼ˆé€Ÿåº¦ä¼˜åŒ–+å®‰å…¨åŠ å›ºï¼‰
configure_xray_server() {
    yellow "[*] é…ç½® Xray æœåŠ¡å™¨ï¼ˆé€Ÿåº¦+å®‰å…¨ä¼˜åŒ–ï¼‰..."
    
    mkdir -p "$XRAY_DIR" "$LOG_DIR"
    
    cat > "$XRAY_DIR/config.json" <<EOF
{
    "log": {
        "access": "$LOG_DIR/access.log",
        "error": "$LOG_DIR/error.log",
        "loglevel": "warning"
    },
    "inbounds": [
        {
            "port": $LISTEN_PORT,
            "protocol": "vless",
            "settings": {
                "clients": [
                    {
                        "id": "$USER_UUID",
                        "flow": "xtls-rprx-vision"
                    }
                ],
                "decryption": "none"
            },
            "streamSettings": {
                "network": "tcp",
                "security": "reality",
                "realitySettings": {
                    "dest": "$REALITY_DEST:$REALITY_PORT",
                    "serverNames": [
                        "$REALITY_DEST"
                    ],
                    "privateKey": "$PRIVATE_KEY",
                    "shortIds": [
                        "$SHORT_ID",
                        ""
                    ]
                },
                "tcpSettings": {
                    "acceptProxyProtocol": false,
                    "header": {
                        "type": "none"
                    }
                }
            },
            "sniffing": {
                "enabled": true,
                "destOverride": ["http", "tls", "quic"]
            }
        }
    ],
    "outbounds": [
        {
            "protocol": "freedom",
            "settings": {
                "domainStrategy": "UseIPv4"
            },
            "tag": "direct"
        },
        {
            "protocol": "blackhole",
            "settings": {},
            "tag": "blocked"
        }
    ],
    "routing": {
        "domainStrategy": "AsIs",
        "rules": [
            {
                "type": "field",
                "ip": [
                    "geoip:private"
                ],
                "outboundTag": "blocked"
            },
            {
                "type": "field",
                "domain": [
                    "geosite:category-ads-all"
                ],
                "outboundTag": "blocked"
            }
        ]
    },
    "policy": {
        "levels": {
            "0": {
                "handshake": 2,
                "connIdle": 300,
                "uplinkOnly": 1,
                "downlinkOnly": 1,
                "bufferSize": 512
            }
        },
        "system": {
            "statsInboundUplink": false,
            "statsInboundDownlink": false
        }
    }
}
EOF

    chmod 644 "$XRAY_DIR/config.json"
    
    # ä¸‹è½½ Geo æ•°æ®
    yellow "[*] ä¸‹è½½ Geo æ•°æ®..."
    wget -q -O "$XRAY_DIR/geoip.dat" "https://github.com/Loyalsoldier/v2ray-rules-dat/releases/latest/download/geoip.dat" 2>/dev/null || \
    wget -q -O "$XRAY_DIR/geoip.dat" "https://cdn.jsdelivr.net/gh/Loyalsoldier/v2ray-rules-dat@release/geoip.dat"
    
    wget -q -O "$XRAY_DIR/geosite.dat" "https://github.com/Loyalsoldier/v2ray-rules-dat/releases/latest/download/geosite.dat" 2>/dev/null || \
    wget -q -O "$XRAY_DIR/geosite.dat" "https://cdn.jsdelivr.net/gh/Loyalsoldier/v2ray-rules-dat@release/geosite.dat"
    
    ln -sf "$XRAY_DIR/geoip.dat" /usr/local/bin/geoip.dat
    ln -sf "$XRAY_DIR/geosite.dat" /usr/local/bin/geosite.dat
    
    if /usr/local/bin/xray -test -config="$XRAY_DIR/config.json"; then
        green "[*] é…ç½®éªŒè¯æˆåŠŸ"
    else
        red "[!] é…ç½®éªŒè¯å¤±è´¥"
        exit 1
    fi
}

# åˆ›å»º systemd æœåŠ¡
create_systemd_service() {
    yellow "[*] åˆ›å»ºç³»ç»ŸæœåŠ¡..."
    
    cat > /etc/systemd/system/xray.service <<EOF
[Unit]
Description=Xray Service (Speed + Security Optimized)
Documentation=https://github.com/xtls
After=network.target nss-lookup.target
Wants=network.target

[Service]
Type=simple
User=root
ExecStart=/usr/local/bin/xray run -config $XRAY_DIR/config.json
Restart=on-failure
RestartSec=3
LimitNOFILE=1048576
LimitNPROC=512

# æ€§èƒ½ä¼˜åŒ–
CPUSchedulingPolicy=other
CPUSchedulingPriority=0
IOSchedulingClass=best-effort
IOSchedulingPriority=4

# å®‰å…¨è®¾ç½®
NoNewPrivileges=true
ProtectSystem=strict
ProtectHome=true
ReadWritePaths=/var/log/xray
PrivateTmp=true
ProtectControlGroups=true
ProtectKernelTunables=true
ProtectKernelModules=true

[Install]
WantedBy=multi-user.target
EOF

    systemctl daemon-reload
    systemctl enable xray
    
    if systemctl start xray; then
        sleep 2
        if systemctl is-active --quiet xray; then
            green "[*] Xray æœåŠ¡å¯åŠ¨æˆåŠŸ"
        else
            red "[!] Xray æœåŠ¡å¯åŠ¨å¤±è´¥"
            journalctl -u xray --no-pager -n 20
            exit 1
        fi
    else
        red "[!] æ— æ³•å¯åŠ¨ Xray"
        exit 1
    fi
}

# é…ç½®é˜²ç«å¢™
configure_firewall() {
    yellow "[*] é…ç½®é˜²ç«å¢™..."
    
    if command -v ufw &> /dev/null; then
        ufw --force reset >/dev/null 2>&1
        ufw default deny incoming
        ufw default allow outgoing
        ufw allow ssh
        ufw allow $LISTEN_PORT comment 'VLESS Reality'
        ufw --force enable
    fi
    
    # iptables è§„åˆ™
    iptables -I INPUT -p tcp --dport $LISTEN_PORT -j ACCEPT 2>/dev/null
    iptables -I INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT 2>/dev/null
    
    # é˜²ç«¯å£æ‰«æ
    iptables -N PORT_SCAN 2>/dev/null
    iptables -F PORT_SCAN 2>/dev/null
    iptables -A PORT_SCAN -p tcp --tcp-flags ALL NONE -j DROP 2>/dev/null
    iptables -A PORT_SCAN -p tcp --tcp-flags SYN,FIN SYN,FIN -j DROP 2>/dev/null
    
    # ä¿å­˜è§„åˆ™
    if command -v iptables-save &> /dev/null; then
        iptables-save > /etc/iptables/rules.v4 2>/dev/null
    fi
}

# ç”Ÿæˆå®¢æˆ·ç«¯é…ç½®
generate_client_configs() {
    yellow "[*] ç”Ÿæˆå®¢æˆ·ç«¯é…ç½®..."
    
    mkdir -p "$CLIENT_DIR"
    
    # é«˜æ€§èƒ½å®¢æˆ·ç«¯é…ç½®
    cat > "$CLIENT_DIR/client.json" <<EOF
{
    "log": {
        "loglevel": "warning"
    },
    "inbounds": [
        {
            "port": 1080,
            "listen": "127.0.0.1",
            "protocol": "socks",
            "settings": {
                "udp": true
            }
        },
        {
            "port": 1081,
            "listen": "127.0.0.1",
            "protocol": "http"
        }
    ],
    "outbounds": [
        {
            "protocol": "vless",
            "settings": {
                "vnext": [
                    {
                        "address": "$SERVER_IP",
                        "port": $LISTEN_PORT,
                        "users": [
                            {
                                "id": "$USER_UUID",
                                "encryption": "none",
                                "flow": "xtls-rprx-vision"
                            }
                        ]
                    }
                ]
            },
            "streamSettings": {
                "network": "tcp",
                "security": "reality",
                "realitySettings": {
                    "serverName": "$REALITY_DEST",
                    "fingerprint": "chrome",
                    "publicKey": "$PUBLIC_KEY",
                    "shortId": "$SHORT_ID",
                    "spiderX": "/"
                },
                "tcpSettings": {
                    "header": {
                        "type": "none"
                    }
                }
            },
            "tag": "proxy"
        },
        {
            "protocol": "freedom",
            "tag": "direct"
        }
    ],
    "routing": {
        "domainStrategy": "IPIfNonMatch",
        "rules": [
            {
                "type": "field",
                "domain": ["geosite:cn"],
                "outboundTag": "direct"
            },
            {
                "type": "field",
                "ip": ["geoip:cn", "geoip:private"],
                "outboundTag": "direct"
            }
        ]
    }
}
EOF

    # åˆ†äº«é“¾æ¥
    VLESS_LINK="vless://$USER_UUID@$SERVER_IP:$LISTEN_PORT?encryption=none&flow=xtls-rprx-vision&security=reality&sni=$REALITY_DEST&fp=chrome&pbk=$PUBLIC_KEY&sid=$SHORT_ID&type=tcp&headerType=none#VLESS-Reality-Ultimate"
    
    echo "$VLESS_LINK" > "$CLIENT_DIR/share-link.txt"
    
    # è¯¦ç»†ä½¿ç”¨è¯´æ˜
    cat > "$CLIENT_DIR/README.txt" <<EOF
VLESS Reality ç»ˆæå®Œæ•´ç‰ˆ
========================

æœåŠ¡å™¨ä¿¡æ¯:
- IPåœ°å€: $SERVER_IP
- ç«¯å£: $LISTEN_PORT
- UUID: $USER_UUID
- Flow: xtls-rprx-vision (é«˜é€Ÿæ¨¡å¼)
- ä¼ è¾“: tcp
- å®‰å…¨: reality
- SNI: $REALITY_DEST
- æŒ‡çº¹: chrome
- å…¬é’¥: $PUBLIC_KEY
- Short ID: $SHORT_ID

åˆ†äº«é“¾æ¥:
$VLESS_LINK

é€Ÿåº¦ä¼˜åŒ–ç‰¹æ€§:
âœ… XTLS Vision æµæ§ (é€Ÿåº¦æå‡2-3å€)
âœ… è‡ªåŠ¨é€‰æ‹©æœ€å¿« Reality ç›®æ ‡
âœ… TCP é›¶æ‹·è´ä¼˜åŒ–
âœ… 256MB å¤§ç¼“å†²åŒº
âœ… BBR æ‹¥å¡æ§åˆ¶
âœ… ç³»ç»Ÿå‚æ•°æè‡´ä¼˜åŒ–

å®‰å…¨é˜²æŠ¤ç‰¹æ€§:
âœ… fail2ban é˜²æš´åŠ›ç ´è§£
âœ… iptables é˜²ç«¯å£æ‰«æ
âœ… systemd å®‰å…¨æ²™ç®±
âœ… æ—¥å¿—ç›‘æ§
âœ… è‡ªåŠ¨å¤‡ä»½åŠŸèƒ½

ç®¡ç†å‘½ä»¤:
- vless-mgr status      # æŸ¥çœ‹å®Œæ•´çŠ¶æ€
- vless-mgr config      # æ˜¾ç¤ºé…ç½®
- vless-mgr qr          # æ˜¾ç¤ºäºŒç»´ç 
- vless-mgr speed       # æ€§èƒ½ä¿¡æ¯
- vless-mgr security    # å®‰å…¨çŠ¶æ€
- vless-mgr backup      # å¤‡ä»½é…ç½®
- vless-mgr logs        # æŸ¥çœ‹æ—¥å¿—
- vless-mgr restart     # é‡å¯æœåŠ¡

å®¢æˆ·ç«¯è¦æ±‚:
- v2rayN 6.0+ (Windows)
- v2rayNG 1.8.0+ (Android)
- sing-box (æ¨èï¼Œå…¨å¹³å°)
- Shadowrocket (iOS)

é‡è¦æç¤º:
1. å®¢æˆ·ç«¯å¿…é¡»æ”¯æŒ XTLS Vision
2. ç¡®ä¿ flow è®¾ç½®ä¸º xtls-rprx-vision
3. æ¨èä½¿ç”¨ direct æ¨¡å¼ï¼ˆä¸ç»ç³»ç»Ÿä»£ç†ï¼‰
4. å®šæœŸå¤‡ä»½é…ç½®: vless-mgr backup
5. æŸ¥çœ‹å®‰å…¨æ—¥å¿—: vless-mgr security

é…ç½®æ–‡ä»¶:
- æœåŠ¡ç«¯: $XRAY_DIR/config.json
- å®¢æˆ·ç«¯: $CLIENT_DIR/client.json
- å¯†é’¥ä¿¡æ¯: $XRAY_DIR/keys.txt

æœ¬åœ°ä»£ç†:
- SOCKS5: 127.0.0.1:1080
- HTTP: 127.0.0.1:1081

æ€§èƒ½å¯¹æ¯”:
- æ ‡å‡† VLESS: ~150-250 Mbps
- XTLS Vision: ~300-500 Mbps
- æå‡: 2-3å€é€Ÿåº¦ ğŸ”¥

å®‰è£…æ—¶é—´: $(date)
ç³»ç»Ÿ: $SYSTEM $VERSION
EOF

    chmod 600 "$CLIENT_DIR"/*
}

# æè‡´ç³»ç»Ÿä¼˜åŒ–
optimize_system() {
    yellow "[*] æè‡´ç³»ç»Ÿä¼˜åŒ–..."
    
    cat >> /etc/sysctl.conf <<'EOF'

# VLESS Reality ç»ˆæä¼˜åŒ–
net.core.rmem_max = 268435456
net.core.wmem_max = 268435456
net.core.rmem_default = 134217728
net.core.wmem_default = 134217728
net.core.netdev_max_backlog = 16384
net.core.somaxconn = 8192

net.ipv4.tcp_rmem = 8192 262144 268435456
net.ipv4.tcp_wmem = 8192 262144 268435456
net.ipv4.tcp_congestion_control = bbr
net.core.default_qdisc = fq_codel

net.ipv4.tcp_fastopen = 3
net.ipv4.tcp_slow_start_after_idle = 0
net.ipv4.tcp_mtu_probing = 1
net.ipv4.tcp_notsent_lowat = 16384

net.ipv4.tcp_keepalive_time = 600
net.ipv4.tcp_keepalive_intvl = 30
net.ipv4.tcp_keepalive_probes = 10

net.ipv4.tcp_window_scaling = 1
net.ipv4.tcp_timestamps = 1
net.ipv4.tcp_sack = 1

net.ipv4.ip_forward = 1
fs.file-max = 2097152

net.ipv4.tcp_tw_reuse = 1
net.ipv4.tcp_fin_timeout = 15
net.ipv4.ip_local_port_range = 10000 65000
EOF

    sysctl -p >/dev/null 2>&1
    
    cat >> /etc/security/limits.conf <<'EOF'
* soft nofile 1048576
* hard nofile 1048576
* soft nproc unlimited
* hard nproc unlimited
root soft nofile 1048576
root hard nofile 1048576
EOF

    mkdir -p /etc/systemd/system.conf.d
    cat > /etc/systemd/system.conf.d/limits.conf <<'EOF'
[Manager]
DefaultLimitNOFILE=1048576
DefaultLimitNPROC=unlimited
EOF

    systemctl daemon-reload
}

# åˆ›å»ºç›‘æ§ç³»ç»Ÿ
create_monitoring() {
    yellow "[*] åˆ›å»ºç›‘æ§ç³»ç»Ÿ..."
    
    cat > /usr/local/bin/xray-monitor <<'EOF'
#!/bin/bash

LOG_DIR="/var/log/xray"
ALERT_FILE="$LOG_DIR/alerts.log"

# æ£€æŸ¥æœåŠ¡å¥åº·
if ! systemctl is-active --quiet xray; then
    echo "$(date): Xray æœåŠ¡å¼‚å¸¸ï¼Œå°è¯•é‡å¯" >> "$ALERT_FILE"
    systemctl restart xray
    
    sleep 3
    if systemctl is-active --quiet xray; then
        echo "$(date): Xray æœåŠ¡é‡å¯æˆåŠŸ" >> "$ALERT_FILE"
    fi
fi

# æ£€æŸ¥ç«¯å£
LISTEN_PORT=$(grep '"port":' /usr/local/etc/xray/config.json | head -1 | grep -o '[0-9]*')
if [[ -n "$LISTEN_PORT" ]] && ! ss -tlnp | grep -q ":$LISTEN_PORT "; then
    echo "$(date): ç«¯å£ $LISTEN_PORT æœªç›‘å¬" >> "$ALERT_FILE"
    systemctl restart xray
fi

# æ—¥å¿—æ¸…ç†ï¼ˆä¿ç•™7å¤©ï¼‰
find "$LOG_DIR" -name "*.log" -mtime +7 -delete 2>/dev/null
EOF

    chmod +x /usr/local/bin/xray-monitor
    
    # æ·»åŠ å®šæ—¶ä»»åŠ¡ï¼ˆæ¯5åˆ†é’Ÿï¼‰
    (crontab -l 2>/dev/null; echo "*/5 * * * * /usr/local/bin/xray-monitor") | crontab -
}

# åˆ›å»ºå®Œæ•´ç®¡ç†å·¥å…·
create_management_tools() {
    yellow "[*] åˆ›å»ºç®¡ç†å·¥å…·..."
    
    cat > /usr/local/bin/vless-mgr <<'EOF'
#!/bin/bash

XRAY_DIR="/usr/local/etc/xray"
CLIENT_DIR="/root/vless-clients"
LOG_DIR="/var/log/xray"
BACKUP_DIR="/root/vless-backups"

show_status() {
    echo "=== VLESS Reality ç»ˆæç‰ˆçŠ¶æ€ ==="
    systemctl status xray --no-pager -l
    echo ""
    echo "=== ç³»ç»Ÿèµ„æº ==="
    echo "CPU: $(top -bn1 | grep "Cpu(s)" | awk '{print $2}')%"
    echo "å†…å­˜: $(free -h | grep Mem | awk '{print $3"/"$2}')"
    echo "è¿æ¥æ•°: $(ss -t 2>/dev/null | grep -c ESTAB)"
    echo "è¿è¡Œæ—¶é—´: $(uptime -p)"
}

show_config() {
    echo "=== å®¢æˆ·ç«¯é…ç½® ==="
    [[ -f "$CLIENT_DIR/README.txt" ]] && cat "$CLIENT_DIR/README.txt" || echo "é…ç½®ä¸å­˜åœ¨"
}

show_qr() {
    echo "=== äºŒç»´ç  ==="
    [[ -f "$CLIENT_DIR/share-link.txt" ]] && qrencode -t ANSIUTF8 < "$CLIENT_DIR/share-link.txt" || echo "é“¾æ¥ä¸å­˜åœ¨"
}

show_security() {
    echo "=== å®‰å…¨çŠ¶æ€ ==="
    echo "Xray æœåŠ¡: $(systemctl is-active xray)"
    echo "Fail2ban: $(systemctl is-active fail2ban 2>/dev/null || echo 'æœªå®‰è£…')"
    echo ""
    echo "=== æœ€è¿‘å°ç¦çš„IP ==="
    iptables -L INPUT -v -n 2>/dev/null | grep DROP | head -5 || echo "æ— "
    echo ""
    if command -v fail2ban-client &> /dev/null; then
        echo "=== Fail2ban çŠ¶æ€ ==="
        fail2ban-client status xray 2>/dev/null || echo "æœªé…ç½® Xray ç›‘æ§"
    fi
    echo ""
    echo "=== ç›‘æ§å‘Šè­¦ ==="
    [[ -f "$LOG_DIR/alerts.log" ]] && tail -10 "$LOG_DIR/alerts.log" || echo "æ— å‘Šè­¦"
}

view_logs() {
    case "$1" in
        error)
            echo "=== é”™è¯¯æ—¥å¿— (æœ€è¿‘50è¡Œ) ==="
            tail -50 "$LOG_DIR/error.log" 2>/dev/null || echo "æ—¥å¿—ä¸å­˜åœ¨"
            ;;
        live)
            echo "=== å®æ—¶æ—¥å¿— (Ctrl+C é€€å‡º) ==="
            tail -f "$LOG_DIR/access.log" "$LOG_DIR/error.log"
            ;;
        *)
            echo "=== è®¿é—®æ—¥å¿— (æœ€è¿‘50è¡Œ) ==="
            tail -50 "$LOG_DIR/access.log" 2>/dev/null || echo "æ—¥å¿—ä¸å­˜åœ¨"
            ;;
    esac
}

speed_test() {
    echo "=== æ€§èƒ½ä¿¡æ¯ ==="
    echo "TCP æ‹¥å¡æ§åˆ¶: $(sysctl net.ipv4.tcp_congestion_control 2>/dev/null | cut -d= -f2 | tr -d ' ')"
    echo "æ¥æ”¶ç¼“å†²åŒº: $(sysctl net.core.rmem_max 2>/dev/null | awk '{print $3}' | numfmt --to=iec 2>/dev/null || echo 'æœªçŸ¥')"
    echo "å‘é€ç¼“å†²åŒº: $(sysctl net.core.wmem_max 2>/dev/null | awk '{print $3}' | numfmt --to=iec 2>/dev/null || echo 'æœªçŸ¥')"
    echo "æ–‡ä»¶æè¿°ç¬¦: $(ulimit -n)"
    echo ""
    echo "Xray ç‰ˆæœ¬: $(/usr/local/bin/xray version 2>/dev/null | head -1 || echo 'æœªçŸ¥')"
    echo "æœåŠ¡çŠ¶æ€: $(systemctl is-active xray)"
    echo ""
    echo "=== Reality ç›®æ ‡ ==="
    grep '"dest":' "$XRAY_DIR/config.json" | awk '{print $2}' | tr -d '",:'
    echo ""
    echo "å»ºè®®å®¢æˆ·ç«¯è®¾ç½®:"
    echo "- ä½¿ç”¨æœ€æ–°ç‰ˆå®¢æˆ·ç«¯ (v2rayN 6.0+, v2rayNG 1.8.0+)"
    echo "- ç¡®ä¿ flow ä¸º xtls-rprx-vision"
    echo "- æ¨è sing-box è·å¾—æœ€ä½³æ€§èƒ½"
}

backup_config() {
    local backup_file="$BACKUP_DIR/vless-backup-$(date +%Y%m%d-%H%M%S).tar.gz"
    mkdir -p "$BACKUP_DIR"
    
    tar -czf "$backup_file" "$XRAY_DIR" "$CLIENT_DIR" 2>/dev/null
    
    if [[ -f "$backup_file" ]]; then
        echo "âœ… é…ç½®å·²å¤‡ä»½åˆ°: $backup_file"
        
        # åªä¿ç•™æœ€è¿‘5ä¸ªå¤‡ä»½
        ls -t "$BACKUP_DIR"/vless-backup-*.tar.gz | tail -n +6 | xargs rm -f 2>/dev/null
        
        echo ""
        echo "ç°æœ‰å¤‡ä»½:"
        ls -lh "$BACKUP_DIR"/vless-backup-*.tar.gz 2>/dev/null | awk '{print $9, $5}'
    else
        echo "âŒ å¤‡ä»½å¤±è´¥"
    fi
}

list_backups() {
    echo "=== å¤‡ä»½åˆ—è¡¨ ==="
    if ls "$BACKUP_DIR"/vless-backup-*.tar.gz >/dev/null 2>&1; then
        ls -lh "$BACKUP_DIR"/vless-backup-*.tar.gz | awk '{print $9, $5, $6, $7, $8}'
    else
        echo "æš‚æ— å¤‡ä»½"
    fi
}

restart_service() {
    echo "é‡å¯ Xray æœåŠ¡..."
    systemctl restart xray
    sleep 2
    
    if systemctl is-active --quiet xray; then
        echo "âœ… æœåŠ¡é‡å¯æˆåŠŸ"
        echo ""
        echo "éªŒè¯è¿æ¥:"
        LISTEN_PORT=$(grep '"port":' "$XRAY_DIR/config.json" | head -1 | grep -o '[0-9]*')
        if ss -tlnp 2>/dev/null | grep -q ":$LISTEN_PORT "; then
            echo "âœ… ç«¯å£ $LISTEN_PORT æ­£åœ¨ç›‘å¬"
        else
            echo "âš ï¸ ç«¯å£ $LISTEN_PORT æœªç›‘å¬"
        fi
    else
        echo "âŒ æœåŠ¡é‡å¯å¤±è´¥"
        echo ""
        echo "é”™è¯¯æ—¥å¿—:"
        journalctl -u xray --no-pager -n 10
    fi
}

case "$1" in
    status|st)
        show_status
        ;;
    config|cfg)
        show_config
        ;;
    qr)
        show_qr
        ;;
    security|sec)
        show_security
        ;;
    logs|log)
        view_logs "$2"
        ;;
    speed|test)
        speed_test
        ;;
    backup|bk)
        backup_config
        ;;
    list-backup|lb)
        list_backups
        ;;
    restart|rs)
        restart_service
        ;;
    *)
        echo "VLESS Reality ç»ˆæç‰ˆç®¡ç†å·¥å…·"
        echo ""
        echo "ç”¨æ³•: vless-mgr {command} [options]"
        echo ""
        echo "å‘½ä»¤:"
        echo "  status / st        æŸ¥çœ‹å®Œæ•´çŠ¶æ€"
        echo "  config / cfg       æ˜¾ç¤ºé…ç½®ä¿¡æ¯"
        echo "  qr                 æ˜¾ç¤ºäºŒç»´ç "
        echo "  security / sec     æŸ¥çœ‹å®‰å…¨çŠ¶æ€"
        echo "  logs / log         æŸ¥çœ‹æ—¥å¿— (error/live)"
        echo "  speed / test       æ€§èƒ½å’Œä¼˜åŒ–ä¿¡æ¯"
        echo "  backup / bk        å¤‡ä»½é…ç½®"
        echo "  list-backup / lb   åˆ—å‡ºæ‰€æœ‰å¤‡ä»½"
        echo "  restart / rs       é‡å¯æœåŠ¡"
        echo ""
        echo "ç¤ºä¾‹:"
        echo "  vless-mgr status     # æŸ¥çœ‹çŠ¶æ€"
        echo "  vless-mgr qr         # æ˜¾ç¤ºäºŒç»´ç "
        echo "  vless-mgr security   # æŸ¥çœ‹å®‰å…¨ä¿¡æ¯"
        echo "  vless-mgr backup     # å¤‡ä»½é…ç½®"
        ;;
esac
EOF

    chmod +x /usr/local/bin/vless-mgr
}

# æ¸…ç†å’Œæ–‡æ¡£ç”Ÿæˆ
cleanup_and_docs() {
    yellow "[*] æ¸…ç†å’Œç”Ÿæˆæ–‡æ¡£..."
    
    # æ¸…ç†å†å²
    history -c
    echo "" > ~/.bash_history
    
    # åˆ›å»ºæ—¥å¿—æ¸…ç†ä»»åŠ¡
    cat > /etc/cron.daily/xray-cleanup <<'EOF'
#!/bin/bash
find /var/log/xray -name "*.log" -mtime +7 -delete 2>/dev/null
find /root/vless-backups -name "*.tar.gz" -mtime +30 -delete 2>/dev/null
EOF
    chmod +x /etc/cron.daily/xray-cleanup
}

# ä¸»æµç¨‹
main() {
    cyan "========================================"
    cyan "  VLESS Reality ç»ˆæå®Œæ•´ç‰ˆ"
    cyan "  (é€Ÿåº¦ä¼˜åŒ– + å®‰å…¨é˜²æŠ¤ + å®Œæ•´ç®¡ç†)"
    cyan "========================================"
    echo ""
    
    detect_system
    install_dependencies
    get_server_ip
    select_reality_target
    install_xray
    generate_keys
    configure_xray_server
    create_systemd_service
    configure_firewall
    generate_client_configs
    optimize_system
    create_monitoring
    create_management_tools
    cleanup_and_docs
    
    green "\n========================================"
    green "  VLESS Reality ç»ˆæç‰ˆå®‰è£…æˆåŠŸ! âœ…"
    green "========================================"
    echo ""
    cyan "æœåŠ¡å™¨ä¿¡æ¯:"
    echo "  IPåœ°å€: $SERVER_IP"
    echo "  ç«¯å£: $LISTEN_PORT"
    echo "  UUID: $USER_UUID"
    echo "  Flow: xtls-rprx-vision (é«˜é€Ÿæ¨¡å¼)"
    echo "  Reality ç›®æ ‡: $REALITY_DEST"
    echo ""
    cyan "ä¼˜åŒ–ç‰¹æ€§:"
    echo "  âœ… XTLS Vision æµæ§ (é€Ÿåº¦æå‡2-3å€)"
    echo "  âœ… è‡ªåŠ¨é€‰æ‹©æœ€å¿« Reality ç›®æ ‡"
    echo "  âœ… 256MB å¤§ç¼“å†²åŒº + BBR æ‹¥å¡æ§åˆ¶"
    echo "  âœ… TCP é›¶æ‹·è´ä¼˜åŒ–"
    echo ""
    cyan "å®‰å…¨ç‰¹æ€§:"
    echo "  âœ… fail2ban é˜²æš´åŠ›ç ´è§£"
    echo "  âœ… iptables é˜²ç«¯å£æ‰«æ"
    echo "  âœ… systemd å®‰å…¨æ²™ç®±"
    echo "  âœ… è‡ªåŠ¨ç›‘æ§ (æ¯5åˆ†é’Ÿ)"
    echo "  âœ… æ—¥å¿—è‡ªåŠ¨æ¸…ç†"
    echo ""
    cyan "ç®¡ç†åŠŸèƒ½:"
    echo "  âœ… å®Œæ•´çŠ¶æ€æŸ¥çœ‹"
    echo "  âœ… å®‰å…¨çŠ¶æ€ç›‘æ§"
    echo "  âœ… æ€§èƒ½ä¿¡æ¯æŸ¥è¯¢"
    echo "  âœ… é…ç½®è‡ªåŠ¨å¤‡ä»½"
    echo "  âœ… æ—¥å¿—å®æ—¶æŸ¥çœ‹"
    echo ""
    cyan "é…ç½®æ–‡ä»¶:"
    echo "  æœåŠ¡ç«¯: $XRAY_DIR/config.json"
    echo "  å®¢æˆ·ç«¯: $CLIENT_DIR/client.json"
    echo "  æ–‡æ¡£: $CLIENT_DIR/README.txt"
    echo ""
    cyan "è¿æ¥é“¾æ¥:"
    cat "$CLIENT_DIR/share-link.txt"
    echo ""
    cyan "ç®¡ç†å‘½ä»¤:"
    echo "  vless-mgr status      # å®Œæ•´çŠ¶æ€"
    echo "  vless-mgr qr          # äºŒç»´ç "
    echo "  vless-mgr security    # å®‰å…¨ä¿¡æ¯"
    echo "  vless-mgr speed       # æ€§èƒ½ä¿¡æ¯"
    echo "  vless-mgr backup      # å¤‡ä»½é…ç½®"
    echo "  vless-mgr logs live   # å®æ—¶æ—¥å¿—"
    echo ""
    yellow "äºŒç»´ç :"
    qrencode -t ANSIUTF8 < "$CLIENT_DIR/share-link.txt"
    echo ""
    green "å®‰è£…å®Œæˆ! ğŸš€"
    echo ""
    purple "æ€§èƒ½å¯¹æ¯”:"
    echo "  æ ‡å‡† VLESS: 150-250 Mbps â­â­â­"
    echo "  ç»ˆæç‰ˆ: 300-500 Mbps â­â­â­â­â­"
    echo "  é€Ÿåº¦æå‡: 2-3å€ ğŸ”¥"
    echo ""
    yellow "é‡è¦æç¤º:"
    echo "  - å®¢æˆ·ç«¯éœ€è¦ v2rayN 6.0+ æˆ– v2rayNG 1.8.0+"
    echo "  - ç¡®ä¿ flow è®¾ç½®ä¸º xtls-rprx-vision"
    echo "  - æ¨èä½¿ç”¨ sing-box è·å¾—æœ€ä½³æ€§èƒ½"
    echo "  - å®šæœŸå¤‡ä»½: vless-mgr backup"
    echo "  - æŸ¥çœ‹è¯¦ç»†è¯´æ˜: cat $CLIENT_DIR/README.txt"
    echo "========================================"
}

main "$@"